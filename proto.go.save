package rabbitmq

import (
	"strings"

	"github.com/rabbitmq/amqp091-go"
	"google.golang.org/protobuf/proto"
)

// ProtoPublishing является вспомогательной функцией для преобразования сообщения формата protobuf в сообщение rabbitMQ.
// В качестве типа сообщения устанавливает названия сообщения protobuf без названия пакета с его определением.
//
//	amqp091.Publishing{
//	    ContentType:   "application/protobuf",
//	    CorrelationId: "ab0123456789",
//	    Type:          "ItemRequest",
//	    Body:          []byte{...},
//	}
func ProtoPublishing(msg proto.Message, id string) amqp091.Publishing {
	data, _ := proto.Marshal(msg)
	name := string(proto.MessageName(msg))
	// обрезаем название пакета из полного имени
	if idx := strings.LastIndexByte(name, '.'); idx > -1 {
		name = name[idx+1:]
	}
	return amqp091.Publishing{
		ContentType:   "application/protobuf",
		CorrelationId: id,
		Type:          name,
		Body:          data,
	}
}
